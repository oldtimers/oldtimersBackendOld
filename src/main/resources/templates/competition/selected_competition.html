<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header_fragment :: headerFragment (title=#{competition}+' - '+${competitionModel.competition.name.getDictionary(#locale)})"></head>
<script th:src="@{/static/js/jquery.tablednd.js}"></script>

<style>
    .dragHandle:hover {
        cursor: move;
    }
</style>

<body>
<div th:replace="fragments/view_fragments :: showRedirections"></div>
<div class="card card-bord">
    <h2 th:text="#{competition}"></h2>
    <form method="post" th:action="@{/__${url}__/edit/competition/__${competitionId}__}"
          th:object="${competitionModel.competition}">
        <table th:replace="fragments/form_pieces :: dictionaryFragment (labels=${ {'__#{label.language}__','__#{label.name}__','__#{label.description}__'} },fieldNames=${ {'name', 'description'} }, languages='competitionModel.languages', fieldTypes=${ {true,false} })"></table>
        <div th:replace="fragments/form_pieces :: number (fieldName='absencePoints', label='__#{competition.absencePoints}__')"></div>
        <div id="BestCategory" th:if="*{type}!=${T(pl.pazurkiewicz.oldtimers_rally.model.CompetitionTypeEnum).COUNTED}">
            <div th:replace="fragments/form_pieces :: number (fieldName='maxRankingPoints', label='__#{competition.maxRankingPoints}__')"></div>
            <div th:replace="fragments/form_pieces :: number (fieldName='numberOfSubsets', label='__#{competition.numberOfSubsets}__')"></div>
        </div>
        <div id="RegularCategory"
             th:if="*{type}==${T(pl.pazurkiewicz.oldtimers_rally.model.CompetitionTypeEnum).REGULAR_DRIVE}">
            <div th:replace="fragments/form_pieces :: number (fieldName='averageSpeed', label='__#{competition.averageSpeed}__')"></div>
            <div th:replace="fragments/form_pieces :: number (fieldName='distance', label='__#{competition.distance}__')"></div>
        </div>
        <div id="functionCode"
             th:unless="*{type}==${T(pl.pazurkiewicz.oldtimers_rally.model.CompetitionTypeEnum).REGULAR_DRIVE}">
            <div th:replace="fragments/form_pieces :: classic (fieldName='functionCode', label='__#{competition.function}__')"></div>
            <p th:text="#{competition.type}+' ' + #{${competitionModel.typeEnums.get(competitionModel.competition.type)}}"></p>
            <table class="table" id="fieldTable" th:if="*{fields.size()} > 0">
                <tr class="nodrop nodrag">
                    <td></td>
                    <td th:text="#{variable}"></td>
                    <td th:text="#{label}"></td>
                    <td th:text="#{type}"></td>
                    <td th:text="#{action}"></td>
                </tr>
                <tr class="fieldRow" th:each="field, info : *{fields}" th:id="${field.order}">
                    <input th:field="${competitionModel.competition.fields[__${info.index}__].order}"
                           th:id="'orderId'+${field.order}" type="hidden">
                    <td class="dragHandle">
                        <img alt="drag" th:src="@{/static/assets/drag.svg}"/>
                    </td>
                    <td th:text="${T(pl.pazurkiewicz.oldtimers_rally.service.CalculatorService).variableMapping.get(__${field.order}__)}"></td>
                    <td>
                        <table th:replace="fragments/form_pieces :: dictionaryFragment (labels=${ {'Language','Label'} },fieldNames=${ {'fields[__${info.index}__].label'} }, languages='competitionModel.languages', fieldTypes=${ {true} })"></table>
                    </td>
                    <td>
                        <label>
                            <p th:text="#{type.field}"></p>
                            <select th:field="*{fields[__${info.index}__].type}">
                                <option th:each="p : ${competitionModel.fieldEnums}"
                                        th:text="#{${p.value}}"
                                        th:value="${p.key}">
                                </option>
                            </select>
                        </label>
                    </td>
                    <td>
                        <button class="btn btn-primary" name="remove" th:text="#{delete}" type="submit"></button>
                    </td>
                </tr>
            </table>
            <button class="btn btn-primary" name="add" th:text="#{add.field}" type="submit"></button>
        </div>


        <div th:replace="fragments/form_pieces :: submitButton (title='__#{save}__')"></div>
    </form>
    <script>
        $(document).ready(function () {
            $("#fieldTable").tableDnD({
                onDrop: function (table, row) {
                    var rows = table.tBodies[0].rows;
                    for (var i = 1; i < rows.length; i++) {
                        var children = rows[i].children;
                        children[0].value = i - 1
                        children[2].textContent = variableName(i - 1)
                    }
                },
                dragHandle: ".dragHandle"
            });
        })

        function variableName(order) {
            switch (order) {
                case 0:
                    return 'a';
                case 1:
                    return 'b';
                case 2:
                    return 'c';
                case 3:
                    return 'd';
                case 4:
                    return 'e';
            }
        }
    </script>
</div>
</body>
</html>
