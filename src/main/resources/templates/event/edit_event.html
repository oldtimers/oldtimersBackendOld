<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header_fragment :: headerFragment (title='__#{event.edit}__')"></head>
<link rel="stylesheet" th:href="@{/static/css/global-settings.css}"/>
<link rel="stylesheet" th:href="@{/static/css/login-register.css}"/>
<link rel="stylesheet" th:href="@{/static/css/event.css}"/>
<link rel="stylesheet" th:href="@{/static/css/navbar.css}"/>
<body>
<div class="container">
    <div th:replace="fragments/navbar :: myNavbar (links=${ {'advanced','privileges','crews','competitions','categories'} })"></div>
    <div class="col-4">
        <h3 class="back-button"><a th:href="@{'/'+${url}}" class="text-white" th:text="#{back}"></a></h3>
    </div>
    <div class="col-4" style="display: flex; width: 100%; justify-content: end;">
        <div th:if="${event.stage} != ${T(pl.pazurkiewicz.oldtimers_rally.model.StageEnum).NEW} and ${event.stage} != ${T(pl.pazurkiewicz.oldtimers_rally.model.StageEnum).PRESENTS}">
            <form method="post" th:action="@{/__${url}__/edit/count}" class="alertChanges">
                <button class="btn btn-primary bypassChanges" th:text="#{calculate.points}" type="submit"></button>
            </form>
        </div>
        <div>
            <form class="alertChanges" method="post" th:action="@{/__${url}__/edit/generate_numbers}"
                  th:if="${event.stage} != ${T(pl.pazurkiewicz.oldtimers_rally.model.StageEnum).NEW}">
                <button class="btn btn-primary bypassChanges" th:text="#{generateNumbers}" type="submit"></button>
            </form>
        </div>
        <div>
            <form class="alertChanges" method="post" th:action="@{/__${url}__/edit/qr_codes}">
                <button class="btn btn-primary bypassChanges" th:text="#{generateQR}" type="submit"></button>
            </form>
        </div>
    </div>
    <div>
        <form method="post" th:action="@{/__${url}__/edit}" th:if="${crewsModel.crews.size()} > 0"
              th:object="${crewsModel}">
            <table>
                <thead>
                <tr>
                    <th th:text="#{crew}"></th>
                    <th th:text="#{present}"></th>
                    <!--                <th th:text="#{photo}"></th>-->
                </tr>
                </thead>
                <tr th:each="crewLine, info : *{crews}">
                    <td th:text="${crewLine.crew}"></td>
                    <td>
                        <input class="checkbox-inline" th:field="*{crews[__${info.index}__].crew.present}"
                               type="checkbox">
                    </td>
                </tr>
            </table>
            <div class="button-row">
                <button class="btn btn-primary row-link links"
                        name="present" th:text="#{save}" type="submit">
                </button>
            </div>
        </form>
    </div>
    <div th:if="*{crewsModel.crews.size()} > 0">
        <h2 th:text="#{crews}"></h2>
        <div th:each="crewModel, info : ${crewsModel.crews}">
            <button class="accordion" th:text="${crewModel.crew}"></button>
            <div class="panel">
                <form enctype="multipart/form-data" method="post" th:action="@{/__${url}__/edit}"
                      ` class="alertChanges" th:object="${crewsModel.crews[__${info.index}__]}">
                    <table th:replace="fragments/form_pieces :: dictionaryFragment (labels=${ {'__#{label.language}__','__#{label.description}__'} },fieldNames=${ {'crew.description'} }, languages='crewsModel.languages', fieldTypes=${ {false} })"></table>
                    <div th:replace="fragments/form_pieces :: classic (fieldName='crew.car', label='__#{crew.car}__')"></div>
                    <div th:replace="fragments/form_pieces :: number (fieldName='crew.yearOfProduction', label='__#{crew.yearOfProduction}__')"></div>
                    <div th:replace="fragments/form_pieces :: classic (fieldName='crew.driverName', label='__#{crew.driverName}__')"></div>
                    <div th:replace="fragments/form_pieces :: number (fieldName='crew.phone', label='__#{phone}__')"></div>
                    <div th:replace="fragments/form_pieces :: categoryTableFragment (fieldName='categoryTable')"></div>
                    <div>
                        <label th:text="#{photo}"></label>
                        <input accept="image/*" name="photo" type="file"/>
                    </div>
                    <div th:if="${crewModel.crew.photo!=null}">
                        <img class="event-img" alt="No photo" th:src="${crewModel.crew.photo}">
                        <label>
                            <b th:text="#{photo.remove}">Remove photo:</b>
                            <input class="checkbox-inline" name="removePhoto" style="margin: auto" type="checkbox"/>
                        </label>
                    </div>
                    <div class="button-row">
                        <button class="btn btn-primary bypassChanges" name="crew" th:text="#{save}"
                                th:value="${info.index}"
                                type="submit"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</body>

<script>
    var acc = document.getElementsByClassName("accordion");
    var i;

    for (i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function() {
            this.classList.toggle("active");
            var panel = this.nextElementSibling;
            if (panel.style.display === "block") {
                panel.style.display = "none";
            } else {
                panel.style.display = "block";
            }
        });
    }
</script>

<script>
    const tx = document.getElementsByTagName("textarea");
    for (let i = 0; i < tx.length; i++) {
        tx[i].setAttribute("style", "height:" + (tx[i].scrollHeight + 52) + "px;" + "width: 300px;");
        tx[i].addEventListener("input", OnInput, false);
    }

    function OnInput() {
        this.style.height = "auto";
        this.style.height = (this.scrollHeight) + "px";
    }
</script>
<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script>
    (function ($, window) {

        // jQuery Extension
        // The handler is executed at most once for all elements for all event types.
        $.fn.only = function (events, callback) {

            // add listener and save original collection as jQuery object
            var $this = $(this).on(events, myCallback);

            // when callback fires, remove event handler and raise passed in function
            function myCallback(e) {
                $this.off(events, myCallback);
                callback.call(this, e);
            }

            // return original collection
            return this;
        };


        // Wait for document ready
        $(function () {

            var $alerts = $(".alertChanges");

            // only run if we have an element of interest
            if ($alerts.length) {

                var needToConfirm = false;

                // check before leaving
                window.onbeforeunload = function askConfirm(e) {
                    if (needToConfirm) {
                        return e.returnValue = "Are you sure you want to navigate away? " +
                            "Any unsaved data will be lost.";
                    }
                }

                // wait for any other page changes
                setTimeout(function () {
                    needToConfirm = false;
                    listenForChanges();
                }, 1000);

                // if any input element changes, we'll need to confirm exit
                function listenForChanges() {
                    $alerts.find(":input").only('change', function () {
                        needToConfirm = true;
                    });
                }

                // disable confirmation message for select elements
                $(".bypassChanges").click(function () {
                    needToConfirm = false;
                });

            }

        });
    })(jQuery, window);
</script>
</html>
